<!DOCTYPE html>
<html>
<head>
<title>Lab 4 - Computer Architecture I - ShanghaiTech University</title>
<link rel="shortcut icon" type="image/png" href="../../favicon.ico"/>
<meta charset="utf-8">
<style type="text/css">
code {background-color: #ddeeff; color: #000000;}
kbd {background-color: #ddeeff; color: #000000;}
.new {background-color: #ffff00; color: #000000;}

div.checkoff {
  background:#eeeee0;
  padding:0.5em 1.5em 0.5em 1.5em;
  border-radius:1em;
  border:1px solid #ddd;
}

pre {
  background:#adc384;
  padding:0.5em 1.5em 0.5em 1.5em;
/*   border-radius:1em; */
  border:1px solid #ddd;
}


</style>
<link rel="stylesheet" type="text/css" href="../style.css">

</head>
<body>
<header>
<h2>Lab 4</h2>
</header>
<a href="../../">Computer Architecture I</a> <a href="http://www.shanghaitech.edu.cn">ShanghaiTech University</a><br>
<a href="../3">Lab 3</a> Lab 4 <a href="../5">Lab 5</a>

<div class='content'>
<h2>Goals</h2>
<p>
These exercises are intended to give you more practice with function calls and manipulating pointers in RISC-V.
</p>

<h2>Exercises</h2>
<h3>Exercise 1</h3>
<p>This exercise uses the file <tt><a href="../../../19s/labs/4/listmanips.s" download>listmanips.s</a></tt>.</p>

<p>
Take a look at this webpages to learn about the <a href="https://en.wikipedia.org/wiki/MapReduce">MapReduce</a> <a href="https://baike.baidu.com/item/MapReduce">(Chinese)</a> algorithm. In this exercise, you will complete an implementation of <tt>map</tt> in RISC-V. In general, <tt>map</tt> takes a function and a list as arguments and applies the function to each element in the list. Our function will be simplified to mutate the list in-place, rather than creating and returning a new list with the modified values.</p>

<p>Our <tt>map</tt> procedure will take two parameters; the first parameter will be the address of the head node of a singly-linked list whose values are 32-bit integers. So, in C, the structure would be defined as:

</p>

<pre>
struct node {
  int value;
  struct node *next;
};
</pre>
<p>
Our second parameter will be the address of a function that takes one int as an argument and returns an int. We'll use <tt>jalr</tt> (see below) to call this function on the list node values.
</p>
<p>
Our <tt>map</tt> function will recursively go down the list, applying the function to each value of the list nodes, storing the value returned in that node. In C, this would be something like this:
</p>
<pre>
void map(struct node *head, int (*f)(int))
{
  if(!head) { return; }
  head-&gt;value = f(head-&gt;value);
  map(head-&gt;next,f);
}
</pre>
<p> If you haven't seen the <tt>int (*f)(int)</tt> kind of declaration before, don't worry too much about it. Basically it means that <tt>f</tt> is a pointer to a function, which in C is used exactly like any other function.
</p>

<p>
You'll need to use an instruction you might not have learned before to implement this: <tt>jalr</tt>. <tt>jalr</tt> is to <tt>jr</tt> as <tt>jal</tt> is to <tt>j</tt>. It jumps to the address in the given register and stores the address of the next instruction (i.e., <tt>PC+4</tt>) in <tt>ra</tt>. So, if I didn't want to use <tt>jal</tt>, I could use <tt>jalr</tt> to call a function like this:

</p>
<pre>
# I want to call the function garply, but not use jal.
la t0 garply     # so I use la to load the address of garply into a register (t0)
jalr t0          # and then use jalr to jump and link to it.
</pre>

<p>
There are 7 places (6 in <tt>map</tt> and 1 in <tt>main</tt>) in the provided code where it says "<tt>#### YOUR CODE HERE ####</tt>". Replace these with instructions that perform as indicated in the comments to finish the implementation of <tt>map</tt>, and to provide a sample call to <tt>map</tt> with <tt>square</tt> as the function argument. The sample list is already created for you in <tt>create_default_list</tt>. When you've filled in these instructions, running the code should provide you with the following output:
</p>
<pre>
List Before: 9 8 7 6 5 4 3 2 1 0 
List After: 81 64 49 36 25 16 9 4 1 0
</pre>
<p></p>
<div class='checkoff'>
<h4>Checkoff</h4>
<ul><li>Show your TA your test run.</li></ul>
</div>


<h3>Exercise 2</h3>
<p>
Add the prologue and epilogue to the code in <tt><a href="../../../19s/labs/4/nchoosek.s" download>nchoosek.s</a></tt>

so that it computes &quot;n choose k&quot;, the number of combinations of <tt>n</tt> distinct elements
taken <tt>k</tt> at a time. (This is also the <tt>(n,k)</tt> entry in Pascal's triangle.)
</p>

<div class="checkoff">
<h4>Checkoff</h4>
<ul>
	<li>Show your TA your code and its test run.</li>
</ul>
</div>

<h3>Exercise 3</h3>

<p>
Write two versions of a function named <tt>first1pos</tt> (starting from <tt><a href="../../../19s/labs/4/first1pos.s" download>first1pos.s</a></tt>) that, given a value in <tt>a1</tt>,
returns in <tt>a0</tt> the position of the leftmost bit that is set to 1 in the word in <tt>a1</tt>. 
If <tt>a1</tt> contains 0, store -1 in <tt>a0</tt>. 
You are allowed to modify <tt>a1</tt> in the process of finding this position. 
Positions range from 0 (the rightmost bit) to 31 (the sign bit).
</p>

<p>
The first version repeatedly shifts <tt>a1</tt> to the left, checking the sign bit at each shift.
The second version starts a mask at <tt>0x80000000</tt> and repeatedly shifts it right to check each bit in <tt>a1</tt>.
</p>

<div class="checkoff">
<h4>Checkoff</h4>
<ul>
	<li>Show your TA both versions of the function and its test run.</li>
</ul>
</div>
</div>

<footer>
<hr style="clear: both;"/>
<div style="float:left">
<address>
Schwertfeger, S&ouml;ren &lt;<code>soerensch</code> AT <code>shanghaitech.edu.cn</code>&gt;
</address>
<address>
Chundong Wang &lt;<code>wangchd</code> AT <code>shanghaitech.edu.cn</code>&gt;
</address>
Modeled after UC Berkeley's CS61C.<br>
Last modified: <time datetime="2020-03-22">2020-03-22</time>
</div>

</footer>
</body>

</html>