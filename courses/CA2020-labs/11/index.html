<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Lab 11 - Computer Architecture I - ShanghaiTech University</title>
<link rel="shortcut icon" type="image/png" href="../../favicon.ico">

<style type="text/css">
code {background-color: #ddeeff; color: #000000;}
kbd {background-color: #ddeeff; color: #000000;}
.new {background-color: #ffff00; color: #000000;}

.checkoff {
  background:#eeeee0;
  padding:0.5em 1.5em 0.5em 1.5em;
  border-radius:1em;
  border:1px solid #ddd;
}

pre {
  background:#adc384;
  padding:0.5em 1.5em 0.5em 1.5em;
  border:1px solid #ddd;
}


</style>
<link rel="stylesheet" type="text/css" href="../style.css">

</head>
<body>
<header>
<h2>Lab 11</h2>
</header>
<a href="../../">Computer Architecture I</a> <a href="http://www.shanghaitech.edu.cn">ShanghaiTech University</a><br>
<a href="../10">Lab 10</a> Lab 11 <a href="../12">Lab 12</a>

<h2>Objectives:</h2>
<ul>
  <li>Get familiar with Longan Nano</li>
  <li>Understand how to program RISC-V code for Longan Nano</li>
</ul>

<h2>About Longan Nano</h2>
<img src="img/nano.png" alt="" />
<p>Longan Nano is a mini development board based on a RISC-V 32-bit core. And that's why we're using this - Project 4 is based on this board. </p>
<p>The official documentation can be found <a href="https://longan.sipeed.com/en/">here</a>.</p>

<h2 id="software">Environment Setup</h2>
<p>First, since Longan Nano is based on RISC-V architecture and our PC is not, we have to do <a href="https://en.wikipedia.org/wiki/Cross_compiler">cross compile</a> in order for our program to run on this board. Luckily, Longan Nano has official support for a third-party platform PlatformIO and it will handle all of these. </p>
<p>To install PlatformIO, make sure you have installed Python3 and pip3. Run this in command: (you may need to replace python with python3 or something)</p>
<pre>
python -m pip install platformio
</pre>
<p>Also, clone the example project <a href="https://autolab.sist.shanghaitech.edu.cn/gitlab/cs110/lab-11-starter">here</a>.</p>

<h3>Exercise 1 - Longan Nano Hello World</h3>

<p>To compile the example Project, run this in project folder:</p>
<pre>python -m platformio run</pre>
<p>It may take quite a while when first run, as it will automatically install necessary dependencies. The output file will be <code>.pio/build/sipeed-longan-nano/firmware.bin</code> together with other files.</p>
<p>To download the executable file to the development board, you need to first connect the board to your computer via a Type-C cable; then follow the below steps to enter DFU mode of the board (so that you can download files to the board.)</p>
<ul>
	<li>1. Hold BOOT0 button (and do not release)</li>
	<li>2. Hold RESET button (and do not release)</li>
	<li>3. Release RESET button</li>
	<li>4. Release BOOT0 button</li>
</ul>
<p>It may require several attempts for this process to succeed. If done successfully, the screen of board will be frozen or become pure black, and you'll be able to detect this device via the following command:</p>
<pre>./dfu-util -l | grep 28e9:0189</pre>
<p>If there is some output, it means that your board has entered dfu mode successfully and is found by your computer. Please don't use the <code>dfu-util</code> provided by <code>apt-get</code> or PlatformIO, as it's known to have bugs.</p>

<p>Then, you can download the executable to the board:</p>
<pre>./dfu-util -a 0 --dfuse-address 0x08000000:leave -D .pio/build/sipeed-longan-nano/firmware.bin</pre>
<p>This command may raise an error such as "Error during download get_status" in the end; but it actually doesn't matter. If you meet some problems like "Permission denied" in the above steps, please use <code>sudo</code>.</p>
<p>After it's finished, press RESET button. Now you can see 5 lines of "Hello World" on the screen!</p>

<p>We've also provided you a Makefile in the example project folder (You may need to modify its first line). Run <code>make</code> to compile the source code and <code>make download</code> to download the executable to board.</p>

<div class="checkoff"><h4>Checkoff:</h4>
	<ul>
		<li>Show to TA you successfully compiled the example program and downloaded it to board.</li>
	</ul>
</div>

<h3>Exercise 2 - Draw something in RISC-V!</h3>

<p>In the following Project 4, you are asked to implement main functionalities in RISC-V. However, you can call C functions in RISC-V, just like calling a RISC-V function; conversely you can also call a RISC-V function in C.</p>

<p>To implement a RISC-V function that can be called via C, use <code>a0-a7</code> as input parameters sequentially, and use <code>a0</code> as output. For example:</p>
<pre>
// C code
int a = add(3, 4, 5); // a = 12

# RISC-V code
# ...
add t0, a0, a1  # a0 - 3, a1 - 4
add t0, t0, a2  # a2 - 5
mv a0, t0       # a0 - return value
# ...
ret
</pre>

<p>Another example for RISC-V code calling C functions:</p>
<pre>
# RISC-V code
li a0, 1;
li a1, 2;
jal sub      # a0 = -1 after this step

// C code
int sub(int a, int b) // a - 1, b - 2
{
	return a - b;
}
</pre>

<p>Most of RISC-V grammar here is the same as in Venus. You don't need to somehow "include" C headers in RISC-V files as PlatformIO will automatically detect and locate them.</p>
<p>Please read <code>/src/lcd/lcd.c</code> carefully. You'll definitely need many of those functions in Project 4.</p> 
<p>For this lab, you need to modify draw.S and call some LCD functions in draw.S to draw a circle, a square and some arbitrary characters on screen.</p>

<div class="checkoff"><h4>Checkoff</h4>
<ul>
	<li>Show the TA your modified code for draw.S .</li>
	<li>Compile the program and download to the board. Show the TA that after pressing the BOOT0 button, the figures appear on the screen.</li>
</ul></div>

<h2 id="hardware">Hardware connection</h2>
<h4 class="checkoff">Note: This part do not need to be done in lab.</h4>
<h3>Board</h3>
<div>
	<p>The Longan Nano we distributed to you contains not only the board, but also a set of housing and pins:</p>
	<img src="img/stuff.jpg" alt="" style="width: 600px; height: 300px;" />
	<p>There should be a button in each of those red rectangles. Cut them down.</p>
	<p>Split the pins like this pattern so you can fit them into the housing.</p>
	<img src="img/parts.jpg" alt="" style="width: 480px; height: 300px;">
	<p>Solder the pins to the board. You'd better solder all the pins or it would easily get loose. Also, Insert the buttons to the top part of the housing like this.</p>
	<img src="img/connect.png" alt="">
	<p>Then you can fit the board in, put on the other part and close it; then the board is done!</p>
	<div><img src="img/box1.jpg" alt="" style="width: 335px;"><img src="img/box2.jpg" alt="" style="width: 400px;"></div>
</div>
<h3>Wiring</h3>
<div>
	<p>The main thing is that you connect your 2 buttons such that: One pin of the button is connected to +5V (or: +3.3V) port on the board; the other connects to an "A" port which accepts an analog input and converts it to digital signal, so our program can detect this.</p>
	<p>Please refer to <a href="/static/ca2020/Discussion_19.mp4">Discussion 19</a> for details.</p>
</div>

<footer>
<hr style="clear: both;"/>
<div style="float:left">
<address>
Schwertfeger, S&ouml;ren &lt;<code>soerensch</code> AT <code>shanghaitech.edu.cn</code>&gt;
</address>
<address>
Chundong Wang &lt;<code>wangchd</code> AT <code>shanghaitech.edu.cn</code>&gt;
</address>
<address>
TA: Ze Song &lt;<code>songze</code> AT <code>shanghaitech.edu.cn</code>&gt;<br />
</address>
Last modified: <time datetime="2020-05-27">2020-05-27</time>
</div>

</footer>
</body>
</html>
